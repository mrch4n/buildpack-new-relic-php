#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e

BUILD_DIR=$1
CACHE_DIR=$2

# Create necessary directories
mkdir -p "$BUILD_DIR/.profile.d"
mkdir -p "$BUILD_DIR/.apt/etc/apt/sources.list.d"
mkdir -p "$BUILD_DIR/.apt/usr/share/keyrings"

# Detect distribution and version
echo "-----> Detecting Linux distribution..."
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$NAME
    VERSION=$VERSION_ID
elif [ -f /etc/lsb-release ]; then
    . /etc/lsb-release
    OS=$DISTRIB_ID
    VERSION=$DISTRIB_RELEASE
fi

# Convert OS name to lowercase for easier comparison
OS=$(echo "$OS" | tr '[:upper:]' '[:lower:]')

echo "-----> Detected OS: $OS $VERSION"

# Add New Relic PHP repository and GPG key
echo "-----> Adding New Relic PHP repository..."
echo 'deb [signed-by=/usr/share/keyrings/download.newrelic.com-newrelic.gpg] http://apt.newrelic.com/debian/ newrelic non-free' > "$BUILD_DIR/.apt/etc/apt/sources.list.d/newrelic.list"

echo "-----> Adding New Relic GPG key..."
curl -fsSL https://download.newrelic.com/548C16BF.gpg | gpg --dearmor -o "$BUILD_DIR/.apt/usr/share/keyrings/download.newrelic.com-newrelic.gpg"

# Update package lists
echo "-----> Updating package lists..."
apt-get update

# Install New Relic PHP agent
echo "-----> Installing New Relic PHP agent..."
DEBIAN_FRONTEND=noninteractive apt-get install -y newrelic-php5

# Configure New Relic PHP agent
echo "-----> Configuring New Relic PHP agent..."
cat > "$BUILD_DIR/.profile.d/newrelic.sh" << EOF
#!/usr/bin/env bash
export NEW_RELIC_APP_NAME=\${NEW_RELIC_APP_NAME:-"PHP Application"}
export NEW_RELIC_LICENSE_KEY=\${NEW_RELIC_LICENSE_KEY:-""}

# Run newrelic-install if not already configured
if [ ! -f "\$HOME/.apt/etc/php/conf.d/newrelic.ini" ]; then
    sudo newrelic-install install
fi
EOF

chmod +x "$BUILD_DIR/.profile.d/newrelic.sh"

echo "-----> New Relic PHP agent installation complete" 